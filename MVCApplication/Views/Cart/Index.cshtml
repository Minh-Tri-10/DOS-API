@using System.Linq

@{
    ViewData["Title"] = "Đặt hàng";
    Layout = "_CustomerLayout";
}
<style>
    /* ===== CART PAGE – WOW UI (dark default; light via :root[data-theme="light"]) ===== */
    /* fallback biến nếu layout chưa có */

    :root {
        --bg: #0b1020;
        --bg-soft: #0f172a;
        --text: #e5e7eb;
        --muted: #9aa3b2;
        --border: rgba(255,255,255,.12);
        --accent: #22d3ee;
        --accent2: #3b82f6;
        --danger: #ef4444;
        --ok: #22c55e;
    }

        :root[data-theme="light"] {
            --bg: #f5f7fb;
            --bg-soft: #ffffff;
            --text: #0f172a;
            --muted: #5b6577;
            --border: rgba(0,0,0,.08);
            --accent: #0ea5e9;
            --accent2: #3b82f6;
            --danger: #dc2626;
            --ok: #16a34a;
        }

    .cart-page {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px;
        color: var(--text);
    }

    .cart-title {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        margin: 0 0 18px;
    }

        .cart-title h2 {
            margin: 0;
            font-weight: 800;
            letter-spacing: .2px;
            line-height: 1.1
        }

        .cart-title .under {
            flex: 1;
            min-width: 160px;
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(90deg,var(--accent),var(--accent2));
            filter: saturate(1.05) brightness(1.05);
            box-shadow: 0 0 22px color-mix(in oklab,var(--accent) 45%, transparent);
        }

    /* Card container */
    .cart-card {
        position: relative;
        isolation: isolate;
        overflow: hidden;
        background: color-mix(in oklab,var(--bg-soft) 92%, transparent);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: 0 12px 32px rgba(2,8,23,.5), 0 1px 0 color-mix(in oklab,#fff 6%, transparent) inset;
    }

        .cart-card::before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            z-index: -1;
            background: conic-gradient(from 180deg, color-mix(in oklab,var(--accent) 40%, transparent), color-mix(in oklab,var(--accent2) 40%, transparent), transparent 35%);
            filter: blur(12px) saturate(1.2);
            opacity: .38;
            animation: cartRing 14s linear infinite;
        }

    @@keyframes cartRing {
        to {
            transform: rotate(1turn)
        }
    }

    /* Header bar: select all + remove */
    .cart-head {
        display: flex;
        gap: 14px;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
    }

    .cart-check {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-weight: 700;
    }

    .cart-checkbox {
        width: 18px;
        height: 18px;
        accent-color: var(--accent2);
        cursor: pointer
    }

    /* Grid rows */
    .cart-list {
        display: grid;
    }

    .cart-row {
        display: grid;
        grid-template-columns: auto 90px 1fr 140px 170px 120px; /* checkbox, ảnh, tên, giá, số lượng, line-total */
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        border-bottom: 1px dashed var(--border);
    }

        .cart-row:hover {
            background: linear-gradient(90deg, color-mix(in oklab,var(--accent) 12%, transparent), transparent 50%)
        }

    /* cell types */
    .cart-img {
        width: 90px;
        height: 90px;
        border-radius: 12px;
        object-fit: cover;
        box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    .cart-name {
        font-weight: 800;
        line-height: 1.25
    }

    .cart-meta {
        color: var(--muted);
        font-size: 13.5px
    }

    .cart-price {
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        color: var(--text)
    }

    .cart-line {
        text-align: right;
        font-weight: 800;
        font-variant-numeric: tabular-nums;
        background: linear-gradient(135deg,var(--accent),var(--accent2));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    /* Quantity control */
    .cart-qty {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px;
        background: linear-gradient(180deg, color-mix(in oklab,#fff 7%, transparent), transparent);
    }

        .cart-qty input {
            width: 44px;
            text-align: center;
            background: transparent;
            border: 0;
            outline: 0;
            color: var(--text);
            font-weight: 800;
            font-variant-numeric: tabular-nums;
        }

        .cart-qty .cart-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex; /* ✅ dùng flex thay cho grid */
            align-items: center; /* ✅ canh giữa theo chiều dọc */
            justify-content: center; /* ✅ canh giữa theo chiều ngang */
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            font-size: 18px; /* ✅ tăng size để cân đối */
            line-height: 1; /* ✅ tránh text bị lệch */
            cursor: pointer;
            transition: transform .12s ease, background .2s ease, filter .2s ease;
        }


            .cart-qty .cart-btn:hover {
                transform: translateY(-1px);
                background: rgba(255,255,255,.06)
            }

    /* Footer: note + summary + checkout */
    .cart-foot {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 16px;
        padding: 16px;
        align-items: start;
        border-top: 1px solid var(--border);
    }

    .cart-note {
        display: grid;
        gap: 8px;
    }

        .cart-note textarea {
            min-height: 110px;
            resize: vertical;
            border-radius: 14px;
            padding: 12px;
            background: linear-gradient(180deg, color-mix(in oklab,#fff 7%, transparent), transparent);
            border: 1px solid var(--border);
            color: var(--text);
            outline: none;
        }

    .cart-summary {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        background: linear-gradient(180deg, color-mix(in oklab,#fff 7%, transparent), transparent);
        display: grid;
        gap: 10px;
    }

    .cart-summary-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        color: var(--muted);
    }

        .cart-summary-row .val {
            font-weight: 800;
            color: var(--text);
            font-variant-numeric: tabular-nums
        }

    .cart-total {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding-top: 6px;
        border-top: 1px dashed var(--border);
    }

        .cart-total .val {
            font-weight: 900;
            font-size: 20px;
            font-variant-numeric: tabular-nums;
            background: linear-gradient(135deg,var(--accent),var(--accent2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

    /* Buttons */
    .cart-btn {
        appearance: none;
        border: 0;
        cursor: pointer;
        border-radius: 12px;
        padding: 10px 12px;
        font-weight: 800;
        font-size: 13.5px;
        transition: transform .12s ease, filter .2s ease, opacity .2s ease;
    }

    .cart-btn-primary {
        color: #0b1220;
        background: linear-gradient(135deg,var(--accent),var(--accent2));
        box-shadow: 0 8px 18px color-mix(in oklab,#000 30%, transparent);
    }

        .cart-btn-primary:hover {
            transform: translateY(-1px);
            filter: brightness(1.05)
        }

    .cart-btn-ghost {
        color: var(--text);
        border: 1px solid var(--border);
        background: linear-gradient(180deg, color-mix(in oklab,#fff 7%, transparent), transparent);
    }

        .cart-btn-ghost:hover {
            transform: translateY(-1px)
        }

    .cart-btn:disabled {
        opacity: .6;
        cursor: not-allowed;
        transform: none;
        filter: none
    }

    /* Light tweaks */
    :root[data-theme="light"] .cart-card {
        background: #fff;
        box-shadow: 0 12px 28px rgba(2,8,23,.12)
    }

    :root[data-theme="light"] .cart-qty .cart-btn:hover {
        background: rgba(0,0,0,.06)
    }

    :root[data-theme="light"] .cart-row:hover {
        background: linear-gradient(90deg, color-mix(in oklab,var(--accent) 16%, transparent), transparent 55%)
    }

    .cart-empty-page {
        text-align: center;
        padding: 120px 20px;
        min-height: 80vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text);
    }

    .empty-cart-img {
        width: 180px;
        height: auto;
        opacity: 0.9;
        margin-bottom: 20px;
        animation: floatCart 3s ease-in-out infinite;
    }

    .cart-empty-page h3 {
        font-weight: 800;
        font-size: 24px;
        margin-top: 8px;
    }

    .cart-empty-page p {
        color: var(--muted);
        margin: 6px 0 20px;
        font-size: 15.5px;
    }

    .cart-empty-page .cart-btn-primary {
        color: #0b1220;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        box-shadow: 0 8px 18px color-mix(in oklab,#000 30%, transparent);
        border: none;
        font-weight: 800;
        padding: 10px 18px;
        border-radius: 10px;
        transition: transform .12s ease, filter .2s ease;
    }

        .cart-empty-page .cart-btn-primary:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }



    /* Responsive */
    @@media (max-width: 980px) {
        .cart-row {
            grid-template-columns: auto 80px 1fr 120px 160px 120px
        }

        .cart-foot {
            grid-template-columns: 1fr
        }
    }




    @@media (max-width: 720px) {
        .cart-row {
            grid-template-columns: auto 70px 1fr;
            grid-auto-rows: auto;
            grid-template-areas:
                "check img name"
                "check img meta"
                "check img price"
                "check img qty"
                "check img line";
            row-gap: 8px;
        }

            .cart-row .cell-check {
                grid-area: check;
                align-self: start;
                padding-top: 6px
            }

            .cart-row .cell-img {
                grid-area: img
            }

            .cart-row .cell-name {
                grid-area: name
            }

            .cart-row .cell-meta {
                grid-area: meta
            }

            .cart-row .cell-price {
                grid-area: price
            }

            .cart-row .cell-qty {
                grid-area: qty
            }

            .cart-row .cell-line {
                grid-area: line;
                text-align: left
            }
    }
    /* 1) Nội dung nổi lên trên overlays */
    .cart-card > * {
        position: relative;
        z-index: 1;
    }

    /* 2) Ảnh ly nước ở giữa card + pulse nhẹ (không ảnh hưởng ring xoay trong ::before) */
    .cart-card::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 700px; /* chỉnh kích thước tùy ý */
        height: 700px;
        transform: translate(-50%, -50%);
        background: url('/media/overlays/neon-drink.png') center/contain no-repeat;
        pointer-events: none;
        z-index: 0; /* nằm trên nền, dưới nội dung; ngang hàng ::before */
        opacity: .14;
        filter: blur(14px) saturate(1.1);
        animation: drinkPulse 5.8s ease-in-out infinite;
    }

    /* 3) Tắt ảnh khi theme sáng (giữ nguyên/vẫn xoay nếu bạn muốn ring hoạt động ở sáng thì ĐỪNG chặn ::before) */
    :root[data-theme="light"] .cart-card::after {
        content: none;
    }

    @@keyframes drinkPulse {
        0% {
            opacity: .10;
            filter: blur(16px) saturate(1.05);
            transform: translate(-50%,-50%) scale(.98);
        }

        50% {
            opacity: .30;
            filter: blur(10px) saturate(1.20);
            transform: translate(-50%,-50%) scale(1.02);
        }

        100% {
            opacity: .10;
            filter: blur(16px) saturate(1.05);
            transform: translate(-50%,-50%) scale(.98);
        }
    }
</style>

@model MVCApplication.Models.CartViewModel

<div id="cartContainer">
    @if (Model == null || !Model.CartItems.Any())
    {
        @Html.Partial("_CartEmptyPartial")
    }
    else
    {
        @Html.Partial("_CartContentPartial", Model)
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (() => {

          const fmtVND = n => n.toLocaleString('vi-VN') + '₫';

          const showToast = (message, icon = "info", time = 2000) => {
              const theme = document.documentElement.getAttribute('data-theme') || 'dark';
              const style = theme === 'light'
                  ? { bg: '#ffffff', text: '#0f172a' }
                  : { bg: '#1e293b', text: '#e2e8f0' };

              Swal.fire({
                  toast: true,
                  position: 'top-end',
                  icon,
                  title: message,
                  background: style.bg,
                  color: style.text,
                  showConfirmButton: false,
                  timer: time,
                  timerProgressBar: true,
                  customClass: { popup: 'swal2-toast-custom' }
              });
          };

          // ---------------- API CALLS ----------------
          function updateQuantity(cartItemId, newQty) {
            return $.ajax({
                url: `/api/cart/update/${cartItemId}?quantity=${newQty}`,
                method: 'PUT'
            }).fail(() => showToast("Không cập nhật được số lượng!", "error"));
          }

          function removeItem(cartItemId) {
            return $.ajax({
                url: `/api/cart/remove/${cartItemId}`,
                method: 'DELETE'
            }).fail(() => showToast("Không xóa được sản phẩm!", "error"));
          }

          function reloadCartView() {
            $.ajax({
                url: '/Cart/Refresh',
                method: 'GET',
                success: function (html) {
                    $("#cartContainer").fadeOut(150, function () {
                        $(this).html(html).fadeIn(200);
                        if (window.updateCartBadge) window.updateCartBadge(); // cập nhật badge header nếu có
                    });
                },
                error: function () {
                    showToast("Không thể tải lại giỏ hàng!", "error");
                }
            });
          }

          // ---------------- MAIN CART LOGIC ----------------
          const list = $('#cartList');
          const checkAll = $('#checkAll');
          const removeSelectedBtn = $('#removeSelected');
          const elCount = $('#sumCount');
          const elSubtotal = $('#sumSubtotal');
          const elTotal = $('#sumTotal');
          const checkoutBtn = $('#checkoutBtn');

          function getRowData(row){
            const $row = $(row);
            const id = $row.data('id');
            const price = parseInt($row.data('price')) || 0;
            const qtyInput = $row.find('.cart-qty-input');
            const stockText = $row.find('.cart-meta').text() || "";
            const maxStock = parseInt(stockText.match(/\d+/)?.[0] || "9999");
            let qty = parseInt(qtyInput.val()) || 1;
            return { id, price, qty, qtyInput, maxStock, $row };
          }

          function updateLine(row){
            const { id, price, qty, qtyInput } = getRowData(row);
            qtyInput.val(qty);
            $(`.cart-line[data-id="${id}"]`).text(fmtVND(price * qty));
          }

          function recalc(){
            let count = 0, subtotal = 0;
            $('.cart-row').each(function(){
              const { price, qty } = getRowData(this);
              if ($(this).find('.cart-item-check').is(':checked')){
                count++;
                subtotal += price * qty;
              }
            });
            elCount.text(count);
            elSubtotal.text(fmtVND(subtotal));
            elTotal.text(fmtVND(subtotal));
            checkoutBtn.prop('disabled', count === 0);
            syncCheckAll();
          }

          function syncCheckAll(){
            const total = $('.cart-item-check').length;
            const checked = $('.cart-item-check:checked').length;
            checkAll.prop('checked', total > 0 && total === checked);
            checkAll.prop('indeterminate', checked > 0 && checked < total);
          }

          // ---------------- EVENT HANDLERS ----------------

          // tăng giảm qty
          $(document).on('click', '.cart-dec, .cart-inc', function(){
            const row = $(this).closest('.cart-row');
            const { id, qtyInput, maxStock } = getRowData(row);
            let val = parseInt(qtyInput.val()) || 1;
            if ($(this).hasClass('cart-dec')) val = Math.max(1, val - 1);
            else val = Math.min(maxStock, val + 1);

            if (val >= maxStock && $(this).hasClass('cart-inc'))
                showToast(`Chỉ còn ${maxStock} sản phẩm trong kho!`, "warning");

            qtyInput.val(val);
            updateLine(row);
            recalc();
            updateQuantity(id, val);
          });

          // nhập tay số lượng
          $(document).on('input', '.cart-qty-input', function(){
            const row = $(this).closest('.cart-row');
            const { id, qtyInput, maxStock } = getRowData(row);
            let val = parseInt(qtyInput.val().replace(/[^\d]/g, '')) || 1;
            if (val > maxStock) {
                val = maxStock;
                showToast(`Chỉ còn ${maxStock} sản phẩm trong kho!`, "warning");
            }
            qtyInput.val(val);
            updateLine(row);
            recalc();
            updateQuantity(id, val);
          });

          // chọn checkbox
          $(document).on('change', '.cart-item-check', recalc);
          checkAll.on('change', function(){
            $('.cart-item-check').prop('checked', this.checked);
            recalc();
          });

          // xóa các mục được chọn (AJAX)
          removeSelectedBtn.on('click', function(){
            const selected = $('.cart-item-check:checked');
            if (selected.length === 0){
                showToast("Vui lòng chọn sản phẩm để xóa!", "info");
                return;
            }

            let done = 0;
            selected.each(function(){
                const id = $(this).closest('.cart-row').data('id');
                removeItem(id).done(() => {
                    done++;
                    $(this).closest('.cart-row').remove();
                });
            });

             // hiển thị liền partial trống khi xóa hết
setTimeout(() => {
    showToast(`Đã xóa ${done} sản phẩm!`, "success");
    recalc();

    if ($('.cart-row').length === 0) {
        // ✅ Gọi ngay partial _CartEmptyPartial qua MVC (chuẩn microservice)
        $.get('/Cart/Refresh', html => {
            $("#cartContainer").fadeOut(50, function () {
                $(this).html(html).fadeIn(100);
                if (window.updateCartBadge) window.updateCartBadge();
            });
        });
        return;
    }
}, 50);

          });

          // checkout
          checkoutBtn.on('click', function(){
            const selectedItems = $('.cart-item-check:checked').map(function(){
              const row = $(this).closest('.cart-row');
              return {
                ProductId: parseInt(row.data('product-id')),
                ProductName: row.find('.cart-name').text().trim(),
                Quantity: parseInt(row.find('.cart-qty-input').val()),
                UnitPrice: parseInt(row.data('price'))
              };
            }).get();

            if (selectedItems.length === 0) return;
            sessionStorage.setItem('checkoutItems', JSON.stringify(selectedItems));
            window.location.href = '/Orders/Create';
          });

          // init
          $('.cart-row').each(function(){ updateLine(this); });
          recalc();

        })();
    </script>

    <style>
        .swal2-toast-custom {
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            font-weight: 600;
        }
    </style>
}





